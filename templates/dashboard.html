{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}

{% block content %}
<h2>–†–∞–±–æ—á–∞—è –ø–∞–Ω–µ–ª—å</h2>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="flash-messages">
            {% for message in messages %}
                <div class="flash-message">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="duck-jar-container">
    <div class="jar-wrapper">
        <!-- –ó–æ–Ω–∞, –∫—É–¥–∞ —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è —É—Ç–∫–∏ (–∫–ª–∏–ø—É–µ—Ç—Å—è –ø–æ –∫—Ä–∞—è–º) -->
        <div class="jar-safe" id="jar-safe"></div>

        <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ –±–∞–Ω–∫–∏ -->
        <img src="{{ url_for('static', filename='images/jar.png') }}" alt="–ë–∞–Ω–∫–∞ –¥–ª—è —É—Ç–æ–∫" class="jar-image" id="jar">

        <!-- –°—á—ë—Ç—á–∏–∫ —É—Ç–æ–∫ -->
        <div class="duck-counter">
            <span id="duck-count">0</span>
            <span class="counter-label">—É—Ç–æ–∫</span>
        </div>
    </div>

    <div class="duck-buttons">
        <button class="throw-duck-btn" id="throw-duck">–ö–∏–Ω—É—Ç—å —É—Ç–∫—É</button>
        <button class="delete-all-ducks-btn" id="delete-all-ducks">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö —É—Ç–æ–∫</button>
    </div>
</div>

<div class="dashboard-content">
    <div class="main-content">
        <div class="info-card">
            <h3>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º.</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h4>–°—Ç–∞—Ç—É—Å</h4>
                <select id="user-status" class="status-selector">
                    <option value="–í —Ä–∞–±–æ—Ç–µ">üü¢ –í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="–ù–∞ –æ–±–µ–¥–µ">üçΩÔ∏è –ù–∞ –æ–±–µ–¥–µ</option>
                    <option value="–û—Ç–¥—ã—Ö–∞—é">‚òï –û—Ç–¥—ã—Ö–∞—é</option>
                    <option value="–ó–∞–∫–æ–Ω—á–∏–ª —Ä–∞–±–æ—Ç–∞—Ç—å">üèÅ –ó–∞–∫–æ–Ω—á–∏–ª —Ä–∞–±–æ—Ç–∞—Ç—å</option>
                    <option value="–í—Å—Ç—Ä–µ—á–∞">üìû –í—Å—Ç—Ä–µ—á–∞</option>
                    <option value="–°–∫–æ—Ä–æ –≤–µ—Ä–Ω—É—Å—å">‚è∞ –°–∫–æ—Ä–æ –≤–µ—Ä–Ω—É—Å—å</option>
                </select>
            </div>
            <div class="stat-card">
                <h4>–í—Ä–µ–º—è –≤—Ö–æ–¥–∞</h4>
                <p id="login-time"></p>
            </div>
            <div class="stat-card active-users-card">
                <h4>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
                <div class="active-users-display">
                    <span id="active-users-count" class="users-count">0</span>
                    <div class="active-users-tooltip" id="active-users-tooltip">
                        <div class="tooltip-content" id="active-users-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-panel">
        <div class="chat-header">
            <h4>üí¨ –û–±—â–∏–π —á–∞—Ç</h4>
            <span class="online-users" id="online-users-count">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω: 0</span>
        </div>

        <div class="chat-messages" id="chat-messages"></div>

        <form class="chat-form" id="chat-form" method="POST" action="{{ url_for('send_message') }}">
            <div class="chat-input-group">
                <input type="text" name="message" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required maxlength="200" autocomplete="off">
                <button type="submit" class="send-btn">üì§</button>
            </div>
        </form>
    </div>
</div>

<script>
    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º—è –≤—Ö–æ–¥–∞
    document.getElementById('login-time').textContent = new Date().toLocaleTimeString('ru-RU');

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const statusSelector = document.getElementById('user-status');
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
    const savedStatus = localStorage.getItem('user_status_{{ username }}') || '–í —Ä–∞–±–æ—Ç–µ';
    statusSelector.value = savedStatus;
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    statusSelector.addEventListener('change', function() {
        const newStatus = this.value;
        
        fetch('/update_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                localStorage.setItem('user_status_{{ username }}', newStatus);
            }
        })
        .catch(err => console.error('Error updating status:', err));
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function updateActiveUsers() {
        fetch('/get_active_users')
            .then(r => r.json())
            .then(data => {
                const count = data.users.length;
                const countElement = document.getElementById('active-users-count');
                const listElement = document.getElementById('active-users-list');
                const onlineCountElement = document.getElementById('online-users-count');
                
                countElement.textContent = count;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —á–∞—Ç–µ
                if (onlineCountElement) {
                    onlineCountElement.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω: ${count}`;
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–∞–º–∏
                if (count > 0) {
                    let usersList = '<div class="users-list-header">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω:</div>';
                    data.users.forEach(user => {
                        usersList += `<div class="user-item">
                            <span class="user-name">${user.username}</span>
                            <span class="user-status">${user.status}</span>
                        </div>`;
                    });
                    listElement.innerHTML = usersList;
                } else {
                    listElement.innerHTML = '<div class="no-users">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
                }
            })
            .catch(err => console.error('Error loading active users:', err));
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    updateActiveUsers();
    setInterval(updateActiveUsers, 10000);

    // –ë–∞–Ω–∫–∞ —Å —É—Ç–∫–∞–º–∏ - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    let duckCount = 0;
    let duckComments = {};
    let duckData = {};
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
    function loadDucksFromServer() {
        fetch('/get_ducks')
            .then(r => r.json())
            .then(data => {
                duckCount = data.duckCount || 0;
                duckData = data.duckData || {};
                duckComments = data.duckComments || {};
                
                // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                localStorage.setItem('duckCount_{{ username }}', duckCount);
                localStorage.setItem('duckData_{{ username }}', JSON.stringify(duckData));
                localStorage.setItem('duckComments_{{ username }}', JSON.stringify(duckComments));
                
                document.getElementById('duck-count').textContent = duckCount;
                loadDucksInJar();
            })
            .catch(err => {
                console.error('Error loading ducks from server:', err);
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage
                duckCount = parseInt(localStorage.getItem('duckCount_{{ username }}')) || 0;
                duckComments = JSON.parse(localStorage.getItem('duckComments_{{ username }}')) || {};
                duckData = JSON.parse(localStorage.getItem('duckData_{{ username }}')) || {};
                document.getElementById('duck-count').textContent = duckCount;
                loadDucksInJar();
            });
    }
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    function syncDucksToServer() {
        fetch('/sync_ducks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                duckCount: duckCount,
                duckData: duckData,
                duckComments: duckComments
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º localStorage
                localStorage.setItem('duckCount_{{ username }}', duckCount);
                localStorage.setItem('duckData_{{ username }}', JSON.stringify(duckData));
                localStorage.setItem('duckComments_{{ username }}', JSON.stringify(duckComments));
            }
        })
        .catch(err => console.error('Error syncing ducks:', err));
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadDucksFromServer();
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadDucksFromServer, 30000);

    function loadDucksInJar() {
        const safe = document.getElementById('jar-safe');
        safe.querySelectorAll('.jar-duck').forEach(duck => duck.remove());
        for (let i = 1; i <= duckCount; i++) {
            const duck = duckData[String(i)] || {};
            createJarDuck(i, duck.name, duck.color);
        }
    }

    function createJarDuck(id, name, color) {
        const safe = document.getElementById('jar-safe');
        const duck = document.createElement('div');
        duck.innerHTML = `
            <img src="{{ url_for("static", filename="images/task_01k8jpagftf4hv6dvfwj2twcgb_1761564054_img_0.webp") }}" alt="Duck" style="width: 100%; height: 100%; object-fit: contain;">
            <div class="duck-name-label">${name || `–£—Ç–∫–∞ #${id}`}</div>
        `;
        duck.className = 'jar-duck';
        duck.dataset.duckId = id;

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
        if (color) {
            duck.style.filter = `hue-rotate(${getHueRotation(color)}deg) saturate(1.5) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3))`;
        }

        // –î–µ—Ä–∂–∏–º —É—Ç–∫—É —Å—Ç—Ä–æ–≥–æ –≤–Ω—É—Ç—Ä–∏ "–±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–æ–Ω—ã" –±–∞–Ω–∫–∏
        const duckPx = 42; // —É–≤–µ–ª–∏—á–∏–ª–∏ —Ä–∞–∑–º–µ—Ä —É—Ç–∫–∏
        const sw = safe.clientWidth;
        const sh = safe.clientHeight;
        const maxLeft = Math.max(0, sw - duckPx);
        const maxTop  = Math.max(0, sh - duckPx);

        duck.style.left = (Math.random() * maxLeft) + 'px';
        duck.style.top  = (Math.random() * maxTop) + 'px';
        duck.style.transform = 'rotate(0deg)';

        duck.addEventListener('click', () => showDuckCommentModal(id));
        safe.appendChild(duck);
    }

    function showDuckCommentModal(duckId) {
        const comment = duckComments[String(duckId)] || '';
        const duck = duckData[String(duckId)] || {};
        const duckName = duck.name || `–£—Ç–∫–∞ #${duckId}`;
        const modal = document.createElement('div');
        modal.className = 'duck-modal';
        modal.innerHTML = `
            <div class="duck-modal-content">
                <h3>${duckName} ü¶Ü</h3>
                <textarea id="duck-comment" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —ç—Ç–æ–π —É—Ç–∫–∏...">${comment}</textarea>
                <div class="duck-modal-buttons">
                    <button onclick="saveDuckComment(${duckId})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button onclick="deleteDuck(${duckId})" class="delete-btn">–£–¥–∞–ª–∏—Ç—å —É—Ç–∫—É</button>
                    <button onclick="closeDuckModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function saveDuckComment(duckId) {
        const comment = document.getElementById('duck-comment').value;
        duckComments[String(duckId)] = comment;
        syncDucksToServer();
        closeDuckModal();
    }

    function closeDuckModal() {
        const modal = document.querySelector('.duck-modal');
        if (modal) modal.remove();
    }

    function deleteDuck(duckId) {
        const duckElement = document.querySelector(`[data-duck-id="${duckId}"]`);
        if (duckElement) duckElement.remove();

        delete duckComments[String(duckId)];
        delete duckData[String(duckId)];

        duckCount--;
        document.getElementById('duck-count').textContent = duckCount;

        closeDuckModal();
        renumberDucks();
        syncDucksToServer();
    }

    function renumberDucks() {
        const duckElements = document.querySelectorAll('.jar-duck');
        const newComments = {};
        const newDuckData = {};
        duckElements.forEach((duck, index) => {
            const newId = String(index + 1);
            const oldId = String(duck.dataset.duckId);
            duck.dataset.duckId = newId;
            if (duckComments[oldId]) newComments[newId] = duckComments[oldId];
            if (duckData[oldId]) newDuckData[newId] = duckData[oldId];
        });

        duckComments = newComments;
        duckData = newDuckData;

        duckCount = duckElements.length;
        document.getElementById('duck-count').textContent = duckCount;
    }

    document.getElementById('throw-duck').addEventListener('click', function() {
        showDuckCreationModal();
    });

    function showDuckCreationModal() {
        const modal = document.createElement('div');
        modal.className = 'duck-modal';
        modal.innerHTML = `
            <div class="duck-modal-content">
                <h3>ü¶Ü –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —É—Ç–æ—á–∫—É</h3>
                <div class="duck-creation-form">
                    <label for="duck-name">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ç–æ—á–∫–∏:</label>
                    <input type="text" id="duck-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..." maxlength="20">
                    
                    <label for="duck-color">–¶–≤–µ—Ç —É—Ç–æ—á–∫–∏:</label>
                    <div class="color-picker">
                        <input type="color" id="duck-color" value="#FFD700">
                        <span id="color-preview">ü¶Ü</span>
                    </div>
                </div>
                <div class="duck-modal-buttons">
                    <button onclick="createCustomDuck()">–°–æ–∑–¥–∞—Ç—å —É—Ç–∫—É</button>
                    <button onclick="closeDuckModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é —Ü–≤–µ—Ç–∞
        const colorInput = document.getElementById('duck-color');
        const colorPreview = document.getElementById('color-preview');
        colorInput.addEventListener('input', function() {
            colorPreview.style.filter = `hue-rotate(${getHueRotation(this.value)}deg) saturate(1.5)`;
        });
    }

    function getHueRotation(hexColor) {
        // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ü–≤–µ—Ç–∞ –≤ –ø–æ–≤–æ—Ä–æ—Ç –æ—Ç—Ç–µ–Ω–∫–∞
        const r = parseInt(hexColor.substr(1,2), 16);
        const g = parseInt(hexColor.substr(3,2), 16);
        const b = parseInt(hexColor.substr(5,2), 16);
        return ((r + g + b) / 3) * 1.4; // –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞
    }

    function createCustomDuck() {
        const name = document.getElementById('duck-name').value.trim() || '–£—Ç–æ—á–∫–∞';
        const color = document.getElementById('duck-color').value;
        
        duckCount++;
        document.getElementById('duck-count').textContent = duckCount;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —É—Ç–æ—á–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º String(duckCount) –∫–∞–∫ –∫–ª—é—á –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        duckData[String(duckCount)] = { name: name, color: color };
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º
        syncDucksToServer();

        const jar = document.getElementById('jar');
        jar.classList.add('shake');
        setTimeout(() => jar.classList.remove('shake'), 500);

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–¥–∞—é—â–µ–π —É—Ç–∫–∏
        const wrapper = document.querySelector('.jar-wrapper');
        const duck = document.createElement('div');
        duck.innerHTML = '<img src="{{ url_for("static", filename="images/task_01k8jpagftf4hv6dvfwj2twcgb_1761564054_img_0.webp") }}" alt="Duck" style="width: 100%; height: 100%; object-fit: contain;">';
        duck.className = 'flying-duck';
        duck.style.filter = `hue-rotate(${getHueRotation(color)}deg) saturate(1.5)`;
        duck.style.animation = 'fallIntoDuck 1.5s ease-in forwards';
        wrapper.appendChild(duck);

        setTimeout(() => {
            duck.remove();
            createJarDuck(duckCount, name, color);
        }, 1500);
        
        closeDuckModal();
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —É—Ç–æ–∫
    document.getElementById('delete-all-ducks').addEventListener('click', function() {
        if (duckCount === 0) return;
        if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö ${duckCount} —É—Ç–æ–∫?`)) {
            document.querySelectorAll('.jar-duck').forEach(duck => duck.remove());
            duckCount = 0;
            duckComments = {};
            duckData = {};
            document.getElementById('duck-count').textContent = duckCount;
            syncDucksToServer();
        }
    });

    // –ß–∞—Ç
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');

    function loadMessages() {
        fetch('/get_messages')
            .then(r => r.json())
            .then(data => {
                chatMessages.innerHTML = '';
                data.messages.forEach(message => {
                    const el = document.createElement('div');
                    el.className = 'chat-message';
                    if (message.username === '{{ username }}') el.classList.add('own-message');
                    el.innerHTML = `
                        <div class="message-header">
                            <span class="message-username">${message.username}</span>
                            <span class="message-time">${message.timestamp}</span>
                        </div>
                        <div class="message-text">${message.message}</div>
                    `;
                    chatMessages.appendChild(el);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(err => console.error('Error loading messages:', err));
    }

    loadMessages();
    setInterval(loadMessages, 3000);

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (messageInput.value.trim() === '') return;
        const formData = new FormData(chatForm);
        fetch('/send_message', { method: 'POST', body: formData })
            .then(response => {
                if (response.ok) {
                    messageInput.value = '';
                    loadMessages();
                }
            })
            .catch(err => console.error('Error sending message:', err));
    });
</script>

<style>
    :root{
        /* –ß–£–¢–¨ –ë–û–õ–¨–®–ï –ë–ê–ù–ö–ê (+~12%) */
        --jar-w: 360px;   /* –±—ã–ª–æ 320px */
        --jar-h: 580px;   /* –±—ã–ª–æ 520px */

        /* –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –±–∞–Ω–∫–∏ (–ø–æ–¥ —Å—Ç–µ–∫–ª–æ–º) */
        --safe-left: 60px;
        --safe-right: 60px;
        --safe-top: 125px;
        --safe-bottom: 135px;

        /* –ì–µ–æ–º–µ—Ç—Ä–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        --page-gap: 20px;
        --side-gap: 25px;
        --main-left-offset: calc(var(--jar-w) + 70px); /* —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ ¬´—Å—ä–µ–∑–∂–∞–ª¬ª */
    }

    * { box-sizing: border-box; }
    body { overflow-x: hidden; }

    /* –ë–∞–Ω–∫–∞ —Å —É—Ç–∫–∞–º–∏ */
    .duck-jar-container {
        position: fixed;
        left: var(--side-gap);
        top: 160px;
        z-index: 50;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        width: var(--jar-w);
    }

    .jar-wrapper {
        position: relative;
        width: var(--jar-w);
        height: var(--jar-h);
    }

    .jar-safe{
        position: absolute;
        left: var(--safe-left);
        top: var(--safe-top);
        width: calc(var(--jar-w) - (var(--safe-left) + var(--safe-right)));
        height: calc(var(--jar-h) - (var(--safe-top) + var(--safe-bottom)));
        overflow: hidden;      /* —É—Ç–∫–∏ –Ω–µ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ –∫—Ä–∞—è –±–∞–Ω–∫–∏ */
        z-index: 3;
        pointer-events: none;  /* –∫–ª–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –∫ —É—Ç–∫–∞–º */
    }

    .jar-image {
        position: absolute;
        top: 0; left: 0;
        width: var(--jar-w);
        height: var(--jar-h);
        object-fit: contain;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        z-index: 4;
        pointer-events: none;
        will-change: transform;
    }

    .jar-image.shake { animation: shake 0.5s ease; }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px) rotate(-2deg); }
        50% { transform: translateX(5px) rotate(2deg); }
        75% { transform: translateX(-5px) rotate(-1deg); }
    }

    .duck-counter {
        position: absolute;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%);
        background: #3498db;
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        text-align: center;
        z-index: 5;
    }

    #duck-count { font-size: 1.5em; margin-right: 5px; }
    .counter-label { font-size: 0.9em; }

    .throw-duck-btn,
    .delete-all-ducks-btn {
        width: 100%;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        color: #fff;
    }
    .throw-duck-btn { background: linear-gradient(135deg, #27ae60, #229954); }
    .throw-duck-btn:hover { background: linear-gradient(135deg, #229954, #27ae60); transform: translateY(-2px); }
    .delete-all-ducks-btn { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .delete-all-ducks-btn:hover { background: linear-gradient(135deg, #c0392b, #a93226); transform: translateY(-2px); }

    .duck-buttons {
        display: flex; flex-direction: column; gap: 10px; width: 100%; align-items: center;
    }

    .flying-duck {
        position: absolute;
        width: 42px;
        height: 42px;
        pointer-events: none;
        left: 50%;
        top: -50px;
        z-index: 6;
        will-change: transform, opacity;
    }

    /* –ü—Ä–∏–≤—è–∑–∞–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—é –ø–∞–¥–µ–Ω–∏—è –∫ –≤—ã—Å–æ—Ç–µ –±–∞–Ω–∫–∏ —á–µ—Ä–µ–∑ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
    @keyframes fallIntoDuck {
        0%   { transform: translateX(-50%) translateY(-50px) rotate(0deg);    opacity: 1; }
        30%  { transform: translateX(-50%) translateY(calc(var(--jar-h) * 0.25)) rotate(180deg); opacity: 0.9; }
        70%  { transform: translateX(-50%) translateY(calc(var(--jar-h) * 0.60)) rotate(300deg); opacity: 0.7; }
        85%  { transform: translateX(-50%) translateY(calc(var(--jar-h) * 0.78)) rotate(340deg); opacity: 0.5; }
        100% { transform: translateX(-50%) translateY(calc(var(--jar-h) * 0.88)) rotate(360deg); opacity: 0; }
    }

    .jar-duck {
        position: absolute;
        width: 42px;
        height: 42px;
        cursor: pointer;
        user-select: none;
        z-index: 3;
        transition: transform 0.3s ease, filter 0.3s ease;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        pointer-events: auto;
    }
    .jar-duck:hover {
        transform: scale(1.25) !important;
        filter: drop-shadow(0 4px 8px rgba(255, 215, 0, 0.8)) hue-rotate(0deg) saturate(1.5) !important;
    }

    .duck-name-label {
        position: absolute;
        top: -18px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 10px;
        font-weight: 600;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
        z-index: 10;
    }
    .jar-duck:hover .duck-name-label {
        opacity: 1;
    }

    .duck-modal {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5);
        display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    .duck-modal-content {
        background: #fff; padding: 25px; border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3); max-width: 400px; width: 90%;
    }
    .duck-modal-content h3 { margin: 0 0 15px 0; color: #2c3e50; text-align: center; }
    .duck-modal-content textarea {
        width: 100%; height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px;
        font-size: 14px; resize: vertical; margin-bottom: 15px; font-family: inherit;
    }
    .duck-modal-content textarea:focus { border-color: #3498db; outline: none; }
    
    .duck-creation-form { margin-bottom: 20px; }
    .duck-creation-form label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
    .duck-creation-form input[type="text"] { 
        width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; 
        font-size: 14px; margin-bottom: 15px; font-family: inherit;
    }
    .duck-creation-form input[type="text"]:focus { border-color: #3498db; outline: none; }
    
    .color-picker { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .color-picker input[type="color"] { 
        width: 50px; height: 40px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer;
    }
    .color-picker #color-preview { 
        font-size: 2em; transition: filter 0.3s ease; 
        filter: hue-rotate(45deg) saturate(1.5);
    }
    
    .duck-modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
    .duck-modal-buttons button {
        padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;
        transition: background-color 0.3s ease;
    }
    .duck-modal-buttons button:first-child { background: #3498db; color: #fff; }
    .duck-modal-buttons button:first-child:hover { background: #2980b9; }
    .duck-modal-buttons button:last-child { background: #95a5a6; color: #fff; }
    .duck-modal-buttons button:last-child:hover { background: #7f8c8d; }
    .delete-btn { background: #e74c3c !important; color: #fff !important; }
    .delete-btn:hover { background: #c0392b !important; }

    /* –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .dashboard-content {
        margin-top: var(--page-gap);
        margin-left: var(--main-left-offset);
        margin-right: var(--side-gap);
        padding-bottom: 40px;
        display: flex;
        gap: 20px;
        align-items: flex-start;
        max-width: 1600px;
    }
    .main-content { flex: 1 1 auto; min-width: 0; display: flex; flex-direction: column; }

    .chat-panel {
        flex: 0 0 350px; width: 350px;
        background: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid #e1e8ed; display: flex; flex-direction: column;
        height: 600px; position: sticky; top: 20px;
    }
    .chat-header {
        padding: 15px 20px; border-bottom: 1px solid #e1e8ed;
        background: linear-gradient(135deg, #667eea, #764ba2); color: #fff;
        border-radius: 12px 12px 0 0;
    }
    .chat-header h4 { margin: 0; font-size: 1.1em; font-weight: 600; }
    .online-users { font-size: 0.8em; opacity: 0.9; display: block; margin-top: 3px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
    .chat-message { background: #f8f9fa; border-radius: 8px; padding: 10px; border-left: 3px solid #3498db; }
    .chat-message.own-message { background: #e3f2fd; border-left-color: #2196F3; margin-left: 20px; }
    .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .message-username { font-weight: 600; color: #2c3e50; font-size: 0.85em; }
    .message-time { font-size: 0.75em; color: #7f8c8d; }
    .message-text { color: #34495e; font-size: 0.9em; line-height: 1.4; word-wrap: break-word; }
    .chat-form { padding: 15px; border-top: 1px solid #e1e8ed; background: #f8f9fa; border-radius: 0 0 12px 12px; }
    .chat-input-group { display: flex; gap: 8px; }
    .chat-input-group input {
        flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; outline: none; transition: border-color 0.3s ease;
    }
    .chat-input-group input:focus { border-color: #3498db; }
    .send-btn { padding: 10px 15px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; font-size: 0.9em; }
    .send-btn:hover { background: #2980b9; }

    /* –°–∫—Ä–æ–ª–ª–±–∞—Ä –≤ —á–∞—Ç–µ */
    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .chat-messages::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    .chat-messages::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

    .info-card { background: #f8f9fa; padding: 25px; border-radius: 8px; margin-bottom: 30px; text-align: left; border-left: 4px solid #3498db; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .info-card h3 { margin: 0 0 12px 0; color: #2c3e50; font-size: 1.3em; font-weight: 600; }
    .info-card p { margin: 0; color: #5a6c7d; line-height: 1.6; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin: 30px 0; flex: 1; align-items: stretch; }
    .stat-card { background: #ffffff; padding: 25px; border-radius: 8px; text-align: left; border: 1px solid #e1e8ed; box-shadow: 0 2px 4px rgba(0,0,0,0.08); display: flex; flex-direction: column; justify-content: center; min-height: 120px; transition: all 0.3s ease; }
    .stat-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.12); border-color: #3498db; }
    .stat-card h4 { margin: 0 0 12px 0; color: #7f8c8d; font-size: 0.9em; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card p { margin: 0; color: #2c3e50; font-weight: 600; font-size: 1.4em; }

    /* –°–µ–ª–µ–∫—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ */
    .status-selector {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: 600;
        color: #2c3e50;
        background: #ffffff;
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
    }
    .status-selector:hover {
        border-color: #3498db;
        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
    }
    .status-selector:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ */
    .active-users-card {
        position: relative;
    }
    .active-users-display {
        position: relative;
        display: inline-block;
        cursor: pointer;
    }
    .users-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        font-size: 2em;
        font-weight: 700;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
    }
    .active-users-display:hover .users-count {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    /* –¢—É–ª—Ç–∏–ø —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ */
    .active-users-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(-10px);
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        padding: 15px;
        min-width: 250px;
        max-width: 300px;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s ease;
        z-index: 1000;
        border: 1px solid #e1e8ed;
    }
    .active-users-display:hover .active-users-tooltip {
        opacity: 1;
        pointer-events: auto;
        transform: translateX(-50%) translateY(-20px);
    }
    .active-users-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 8px solid transparent;
        border-top-color: white;
    }
    .tooltip-content {
        max-height: 300px;
        overflow-y: auto;
    }
    .users-list-header {
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e1e8ed;
        font-size: 0.95em;
    }
    .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 6px;
        transition: background 0.2s ease;
    }
    .user-item:hover {
        background: #e3f2fd;
    }
    .user-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9em;
    }
    .user-status {
        font-size: 0.75em;
        color: #7f8c8d;
        background: white;
        padding: 4px 8px;
        border-radius: 12px;
        border: 1px solid #e1e8ed;
    }
    .no-users {
        text-align: center;
        color: #95a5a6;
        font-style: italic;
        padding: 10px;
    }
    .tooltip-content::-webkit-scrollbar { width: 4px; }
    .tooltip-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 2px; }
    .tooltip-content::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 2px; }
    .tooltip-content::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 1024px) { :root{ --main-left-offset: calc(var(--jar-w) + 40px); } }
    @media (max-width: 900px) {
        .duck-jar-container { position: relative; left: auto; top: auto; margin: 0 auto 20px; }
        .dashboard-content { margin-left: var(--side-gap); margin-right: var(--side-gap); flex-direction: column; }
        .chat-panel { width: 100%; height: 420px; position: relative; top: auto; }
    }
    @media (max-width: 480px) {
        :root{
            --jar-w: 260px; --jar-h: 460px;
            --safe-left: 40px; --safe-right: 40px; --safe-top: 95px; --safe-bottom: 105px;
        }
    }
</style>
{% endblock %}